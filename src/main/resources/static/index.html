<!DOCTYPE html>
<html lang="en">
<head>
    <title>Currency calculator</title>
    <style type="text/css">
    </style>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="countryService.js"></script>
    <script src="nbpService.js"></script>
    <link rel="stylesheet" type="text/css" href="app.css">
</head>
<body>
<h1>Calculator</h1>
<form>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div>
                Select country: <br/><select id="chooseCountry"></select>
            </div>
            <div>
                Enter daily Brutto income: <br/><input type="text" id="enteredDailyBruttoIncome" />
                <span id='currencyCode'></span>
            </div>
            <div>
                <br/><input type="button" id="CalculatesTheCurrencyChange" value="Recalculate"/>
            </div>
            <div>
                Your monthly Net income: <br/><input type="text" id="YourMonthlyNettoIncomePln" /> &nbsp; PLN
            </div>
        </div>
    </nav>
</form>

<script>
    $( document ).ready(function() {

        chooseCountry();

        $('#chooseCountry').change( function() {
            updateCurrency( this.value );
        });

        $("#CalculatesTheCurrencyChange").click( function(){
            RecalculateMonthlyNettoIncomeInPLN()
        });

    });



    function RecalculateMonthlyNettoIncomeInPLN() {
        countryService.getCountry( $('#chooseCountry').val(), function(country) {
            var workingDaysInMonth = 22;
            var monthlyNettoIncome =  $("#enteredDailyBruttoIncome").val() *  workingDaysInMonth;
            monthlyNettoIncome = monthlyNettoIncome - (monthlyNettoIncome * country.taxation.value / 100 );
            monthlyNettoIncome -=  country.taxation.constantCosts;

            // convert to PLN
            nbpService.loadCurrencyRate( country.currency.code, function(rate) {
                monthlyNettoIncome *= rate;
                monthlyNettoIncome = monthlyNettoIncome.toFixed(2);
                $('#YourMonthlyNettoIncomePln').val(monthlyNettoIncome);
            });
        });
    };

    function chooseCountry() {
        countryService.getCountries(  function(countryCollection) {
            $.each(countryCollection, function(i, country) {
                $('#chooseCountry').append('<option value="' + country.code + '">' + country.name + '</option>');
                updateCurrency( country.code );
            });
        });
    };

    function updateCurrency( countryCode ) {
        countryService.getCountry( countryCode, function(country){
            $('#currencyCode').text(country.currency.code);
        });
    };

</script>
</body>
</html>